<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Anima: Example 2</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Anima
   &#160;<span id="projectnumber">v0.5</span>
   </div>
   <div id="projectbrief">Parts animation script for Space Engineers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('example2.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Example 2 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>Gravity generator with exposed core and spinning metal caps</h3>
<div class="image">
<img src="animaexample2_model.png" alt="animaexample2_model.png"/>
</div>
<p>This example will consist of 3 parts in the following hierarchy:</p>
<div class="image">
<img src="animaexample2_diagram.png" alt="animaexample2_diagram.png"/>
</div>
<p>The <code>&lt;ROOT&gt;</code> in diagram is the Space Engineers block, it's always static and have physics.</p>
<p>No parts can't have physics but they can freely be animated.</p>
<p>Please read <a class="el" href="example1.html">example 1</a> first if you don't have experience with scripting!</p>
<p>If you need a game-logic script template it is also in <a class="el" href="example1.html">example 1</a>.</p>
<h2>Block type and information </h2>
<p>Locate the following lines:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>YourModName</div><div class="line">{</div><div class="line">    <span class="keyword">using</span> BlockModAPIType = <span class="comment">/*( Mod API Block Type )*/</span> Sandbox.ModAPI.IMyTerminalBlock;</div><div class="line">    [MyEntityComponentDescriptor(typeof(<span class="comment">/*( Object Builder Type )*/</span> MyObjectBuilder_TerminalBlock),</div><div class="line">    <span class="comment">/*( Block name to link with gamelogic )*/</span> <span class="stringliteral">&quot;BlockSubtype&quot;</span>)]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span><span class="comment">/*( Name of the gamelogic class )*/</span> YourModName_Logic : MyGameLogicComponent</div></div><!-- fragment --><p>You can rename the namespace and the class name as you'll like (make sure you respect identifier name format).</p>
<p>For this example we will use the gravity generator instead.</p>
<p>Rename the Mod API Block Type to: <code>Sandbox.ModAPI.Ingame.IMyGravityGenerator</code></p>
<p>Rename the Object Builder Type to: <code>MyObjectBuilder_GravityGenerator</code></p>
<p>You will need to change the block subtype to match the one you defined in CubeBlock file, for this example use "AnimaExample2".</p>
<p>In the end you will have:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><span class="comment">/*(Your personal namespace)*/</span> AnimaExamples.Example2</div><div class="line">{</div><div class="line">    <span class="keyword">using</span> BlockModAPIType = <span class="comment">/*( Mod API Block Type )*/</span> Sandbox.ModAPI.Ingame.IMyGravityGenerator;</div><div class="line">    [MyEntityComponentDescriptor(typeof(<span class="comment">/*( Object Builder Type )*/</span> MyObjectBuilder_GravityGenerator), <span class="comment">/*( Block name to link with gamelogic )*/</span> <span class="stringliteral">&quot;AnimaExample2&quot;</span>)]</div><div class="line">    <span class="keyword">public</span> <span class="keyword">class </span><span class="comment">/*( Name of the gamelogic class )*/</span> AnimaExample2_Logic : MyGameLogicComponent</div></div><!-- fragment --><h2>Variables </h2>
<p>First create the classes required for the Anima, all parts and all sequences:</p>
<p>Inside game-logic's class:</p>
<div class="fragment"><div class="line"><span class="keyword">private</span> Anima m_anima;</div><div class="line"><span class="keyword">private</span> AnimaPart m_part_core;</div><div class="line"><span class="keyword">private</span> AnimaPart m_part_topcap;</div><div class="line"><span class="keyword">private</span> AnimaPart m_part_bottomcap;</div></div><!-- fragment --><p>You can make those protected or public if you require.</p>
<p>Additionally we add:</p>
<div class="fragment"><div class="line"><span class="comment">// This holds the last status so we can discover when the status toggle</span></div><div class="line"><span class="keyword">public</span> <span class="keywordtype">bool</span> lastStatus = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="comment">// This is a helper to know the sequence playing without comparing strings</span></div><div class="line"><span class="keyword">enum</span> SeqPlayingEnum</div><div class="line">{</div><div class="line">    POWER_ON, POWER_OFF, ACTIVE, INACTIVE,</div><div class="line">};</div><div class="line"><span class="keyword">private</span> SeqPlayingEnum seqPlaying = SeqPlayingEnum.POWER_ON;</div></div><!-- fragment --><p>lastStatus is to hold the old value so we can detect edges, e.g. false -&gt; true and true -&gt; false</p>
<p>SeqPlayingEnum is a enumeration of all possible sequences, variable 'seqPlaying' will tell which one is playing. This is much more efficient and quicker than comparing sequences names.</p>
<h2>Initialization </h2>
<p>Inside game-logic's Init():</p>
<div class="fragment"><div class="line"><span class="comment">// No point to run this script if is a dedicated server because there&#39;s no graphics</span></div><div class="line"><span class="keywordflow">if</span> (Anima.DedicatedServer) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line"><span class="comment">// Create the main Anima class</span></div><div class="line">m_anima = <span class="keyword">new</span> Anima();</div><div class="line"></div><div class="line"><span class="comment">// Initialize Anima</span></div><div class="line"><span class="keywordflow">if</span> (!m_anima.Init(Entity as MyEntity, <span class="stringliteral">&quot;Anima Example&quot;</span>, <span class="stringliteral">&quot;AnimaBetaExample&quot;</span>)) <span class="keywordflow">throw</span> <span class="keyword">new</span> ArgumentException(<span class="stringliteral">&quot;Anima failed to initialize!&quot;</span>);</div><div class="line"></div><div class="line"><span class="comment">// Add parts</span></div><div class="line">m_part_core = m_anima.AddPart(null, <span class="stringliteral">@&quot;AnimaExample\ModelCore&quot;</span>);</div><div class="line">m_part_topcap = m_anima.AddPart(m_part_core, <span class="stringliteral">@&quot;AnimaExample\TopCap&quot;</span>);</div><div class="line">m_part_bottomcap = m_anima.AddPart(m_part_core, <span class="stringliteral">@&quot;AnimaExample\BottomCap&quot;</span>);</div><div class="line"></div><div class="line"><span class="comment">// Assign sequences</span></div><div class="line">coreFunctionality(m_part_core);</div><div class="line">m_part_core.OnComplete = coreFunctionality;</div><div class="line"></div><div class="line"><span class="comment">// Play all parts sequences in a loop</span></div><div class="line">m_anima.Play(Anima.Playback.LOOP);</div></div><!-- fragment --><p>The method <code>coreFunctionality()</code> will be defined later and will be responsible to set the proper sequences to play on all parts.</p>
<p>We assign that method on core's <a href="AnimaScript.AnimaPart.OnComplete">OnComplete</a> so it will work as a callback.</p>
<h2>Updating </h2>
<p>WARNING: There's some blocks type in Space Engineers that won't call update even when needed!</p>
<p>Inside game-logic's UpdateAfterSimulation():</p>
<div class="fragment"><div class="line"><span class="comment">// No point to run this script if is a dedicated server because there&#39;s no graphics</span></div><div class="line"><span class="keywordflow">if</span> (Anima.DedicatedServer) <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line"><span class="comment">// Enable Anima based of player distance and if is functional</span></div><div class="line">m_anima.Enable = m_anima.TestPlayerDistance(500.0) &amp;&amp; block.IsFunctional;</div><div class="line"></div><div class="line"><span class="comment">// Only update if is enabled!</span></div><div class="line"><span class="keywordflow">if</span> (m_anima.Enable)</div><div class="line">{</div><div class="line">    anima.Update(anima.GetElapsed());</div><div class="line">}</div></div><!-- fragment --><p>For simplicity we left the "Emissive" material handling out of the code in this page.</p>
<p>While it's very similar to <a class="el" href="example1.html">example1</a> you may notice the additional <code>&amp;&amp; block.IsFunctional</code> code. That small check is to prevent the parts of being visible while the block isn't fully built or operational. Note that if the block gets heavily damage all the parts will disappear (they will reappear once you fix it!).</p>
<p><b>Tip for C# newbie:</b> The symbol <code>&amp;&amp;</code> perform a 'Boolean Logic AND' so both tests must evaluate true to return true.</p>
<h2>Make sequences join together in a finite-state-machine </h2>
<p>Our FSM will look like:</p>
<div class="image">
<img src="animaexample2_fsm_diagram.png" alt="animaexample2_fsm_diagram.png"/>
</div>
<ol type="1">
<li>POWER_ON = When device goes from OFF to ON</li>
<li>POWER_OFF = When the device goes from ON to OFF</li>
<li>ACTIVE = While the device is ON</li>
<li>INACTIVE = While the device is OFF</li>
</ol>
<p>As you can see, we will need 4 sequences per part, since the script can export multiple objects in Blender you can export 1 sequence group at a time.</p>
<p>Keep in mind for this to work you must:</p>
<ul>
<li>All parts sequences have the same keyframe length</li>
<li>Make sure all parts are played at same time with the same speed</li>
</ul>
<p>This is to make sure that all parts animations stay syncronized.</p>
<p>Add this method somewhere inside the game-logic class body:</p>
<div class="fragment"><div class="line"><span class="comment">// Our callback to change sequences</span></div><div class="line"><span class="keyword">public</span> <span class="keywordtype">void</span> coreFunctionality(AnimaPart part)</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> status = block.IsWorking;</div><div class="line">    <span class="keywordflow">if</span> (!lastStatus &amp;&amp; status)</div><div class="line">    {</div><div class="line">        <span class="comment">// Powering on</span></div><div class="line">        m_part_core.Sequence = Seq_Core_powerOn.Adquire();</div><div class="line">        m_part_topcap.Sequence = Seq_TopCap_powerOn.Adquire();</div><div class="line">        m_part_bottomcap.Sequence = Seq_BottomCap_powerOn.Adquire();</div><div class="line">        seqPlaying = SeqPlayingEnum.POWER_ON;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastStatus &amp;&amp; !status)</div><div class="line">    {</div><div class="line">        <span class="comment">// Powering off</span></div><div class="line">        m_part_core.Sequence = Seq_Core_powerOff.Adquire();</div><div class="line">        m_part_topcap.Sequence = Seq_TopCap_powerOff.Adquire();</div><div class="line">        m_part_bottomcap.Sequence = Seq_BottomCap_powerOff.Adquire();</div><div class="line">        seqPlaying = SeqPlayingEnum.POWER_OFF;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status)</div><div class="line">    {</div><div class="line">        <span class="comment">// While active</span></div><div class="line">        m_part_core.Sequence = Seq_Core_active.Adquire();</div><div class="line">        m_part_topcap.Sequence = Seq_TopCap_active.Adquire();</div><div class="line">        m_part_bottomcap.Sequence = Seq_BottomCap_active.Adquire();</div><div class="line">        seqPlaying = SeqPlayingEnum.ACTIVE;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">// While inactive</span></div><div class="line">        m_part_core.Sequence = Seq_Core_inactive.Adquire();</div><div class="line">        m_part_topcap.Sequence = Seq_TopCap_inactive.Adquire();</div><div class="line">        m_part_bottomcap.Sequence = Seq_BottomCap_inactive.Adquire();</div><div class="line">        seqPlaying = SeqPlayingEnum.INACTIVE;</div><div class="line">    }</div><div class="line">    lastStatus = status;</div><div class="line">}</div></div><!-- fragment --><p>As the final note, you can manipulate all parts by using methods on <a href="AnimaScript.Anima">Anima</a> or a specific part on <a href="AnimaScript.AnimaPart">AnimaPart</a>.</p>
<h2>Additional code </h2>
<h3>Global speed</h3>
<p>A quick way to add a global speed is to multiply the elapsed period by the speed:</p>
<div class="fragment"><div class="line">anima.Update(anima.GetElapsed() * m_globalSpeed);</div></div><!-- fragment --><p>Like the part speed, the global speed can be negative.</p>
<h3>Play all animations backwards</h3>
<p>To play an animation on all parts once but backwards, use:</p>
<div class="fragment"><div class="line">m_globalSpeed = -1f;</div><div class="line">m_anima.PlayNormal(Anima.Playback.ONCE, 1f);</div></div><!-- fragment --><p>... or for only a specific part:</p>
<div class="fragment"><div class="line">m_anima_part.Speed = -1f;</div><div class="line">m_anima_part.PlayNormal(Anima.Playback.ONCE, 1f);</div></div><!-- fragment --><p>Note: If global speed is negative and part speed is negative, the playback will be played forward!</p>
<h3>Play from last stopped point</h3>
<p>Resume() can't play an animation unless it got paused.</p>
<p>An easy workaround is to play and immediatelly pause it on initialization:</p>
<div class="fragment"><div class="line">m_anima.Play(Anima.Playback.LOOP);</div><div class="line">m_anima.Pause();</div></div><!-- fragment --><p>Now use Pause() and Resume() to respectively stop and start animation.</p>
<p>In case the animation got stopped, a common solution is:</p>
<div class="fragment"><div class="line">m_anima_part.Play(Anima.Playback.LOOP, m_anima_part.Cursor);</div><div class="line"></div><div class="line">... or ...</div><div class="line"></div><div class="line">m_anima_part.PlayNormal(Anima.Playback.LOOP, m_anima_part.CursorNormal);</div></div><!-- fragment --><h3>Play a specific keyframe</h3>
<div class="fragment"><div class="line">m_anima.Play(Anima.Playback.HALT, keyframe);</div></div><!-- fragment --><p>That simple! The animation is stopped immediately and since Play() apply the transformations there's no need to wait for Update()</p>
<p>Go back to the <a class="el" href="index.html">Main Page</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
